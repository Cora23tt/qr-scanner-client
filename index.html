<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <title>QR-scanner</title>
    <script src="./node_modules/html5-qrcode/html5-qrcode.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-6 offset-md-3">
                <div class="form-group">
                    <label for="cameraSelect">Выберите камеру:</label>
                    <select class="form-control" id="cameraSelect"></select>
                    <div class="alert alert-danger my-3" id="permissionDeniedMessage" style="display: none;">
                        Невозможно получить доступ к камере. Разрешите использование камеры и перезагрузите страницу.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-5">
        <div class="row">
            <div class="col-md-6 offset-md-3">
                <div id="reader" style="width: 100%;"></div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6 offset-md-3">
                <table class="mb-4 table table-success table-striped" id="scannedTable">
                    <thead>
                        <tr>
                            <th>Список отсканированных</th>
                        </tr>
                    </thead>
                    <tbody id="tbody">
                        <!-- Scanned elements will be added here -->
                    </tbody>
                </table>

                <!-- Button trigger modal -->
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#clearTableModal">
                    Очистить
                </button>

                <!-- Modal -->
                <div class="modal fade" id="clearTableModal" tabindex="-1" aria-labelledby="clearTableModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="clearTableModalLabel">Очистить список?</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Нет</button>
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="clearButton">Да</button>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="sendButton">Отправить</button>
            </div>
        </div>
    </div>

    <script>

        const cameraSelect = document.getElementById("cameraSelect");
        const permissionDeniedMessage = document.getElementById("permissionDeniedMessage");
        const html5QrCode = new Html5Qrcode("reader");
        const scannedStrings = [];
        const clearButton = document.getElementById("clearButton");
        const agreeCheckbox = document.getElementById("agreeCheckbox");
        const sendButton = document.getElementById("sendButton");

        clearButton.addEventListener("click", function () {
            clearTable();
        });

        function clearTable() {
            document.getElementById("tbody").innerHTML = "";
            scannedStrings.length = 0;
        }

        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                devices.forEach(device => {
                    const option = document.createElement("option");
                    option.value = device.id;
                    option.text = device.label;
                    cameraSelect.appendChild(option);
                });
                cameraSelect.addEventListener("change", handleCameraSelection);
                handleCameraSelection();
            }
        }).catch(err => {
            permissionDeniedMessage.style.display = "block";
            permissionDeniedMessage.innerHTML = err;
        });

        function onScanSuccess(decodedText, decodedResult) {
            if (!scannedStrings.includes(decodedText)) {
                const scannedTable = document.getElementById("tbody");
                const newRow = scannedTable.insertRow();
                const cell = newRow.insertCell();
                cell.textContent = decodedText;
                scannedStrings.push(decodedText);
            }
        }

        function handleCameraSelection() {
            const CameraId = cameraSelect.value;
            if (html5QrCode.getState() == 2 || html5QrCode.getState() == 3) {
                html5QrCode.stop().then((ignore) => {
                    setTimeout(function () {
                        startCameraById(CameraId);
                    }, 2000);
                    return
                });
            }
            startCameraById(CameraId);
        }

        function startCameraById(CameraId) {
            html5QrCode.start(CameraId,
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText, decodedResult) => {
                    onScanSuccess(decodedText, decodedResult);
                },
                (errorMessage) => {
                    console.log(errorMessage)
                })
                .catch((err) => {
                    alert(err);
                });
        }

        sendButton.addEventListener("click", function () {
            const resultElement = document.getElementById("result");
            const decodedText = resultElement.textContent.replace("Code matched = ", "").trim();

            const formData = new FormData();
            formData.append("string", decodedText);

            fetch("https://onec-qr-scanner.onrender.com/save-string", {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    console.log("Результат отправки в API:", data);
                })
                .catch(error => {
                    console.error("Ошибка при отправке в API:", error);
                });
        });

        document.addEventListener("visibilitychange", function () {
            if (document.hidden) {
                if (html5QrCode.getState() == 2 || html5QrCode.getState() == 3) {
                    html5QrCode.stop().then((ignore) => {
                        setTimeout(function () {
                            console.log('user unfocused, camera stoped');
                        }, 2000);
                        return
                    });
                }
            } else {
                handleCameraSelection();
            }
        });

    </script>
</body>

</html>